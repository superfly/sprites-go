#!/bin/bash
# Language Dependencies Installer for Sprite Environment
# This script installs all the system packages required for the language runtimes
# in the sprite environment. Run this if you're using a minimal base image.

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if running as root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        print_error "This script must be run as root or with sudo"
        exit 1
    fi
}

# Base packages needed for all languages
BASE_PACKAGES=(
    # Build tools
    "build-essential"
    "clang"
    "make"
    "autoconf"
    "automake"
    "libtool"
    "pkg-config"
    
    # Network tools
    "curl"
    "wget"
    "ca-certificates"
    "gnupg"
    "dirmngr"
    
    # Version control
    "git"
    
    # Compression tools
    "unzip"
    "tar"
    "xz-utils"
    "gzip"
    "bzip2"
    "zip"
    
    # Core utilities
    "coreutils"
    "util-linux"
    "findutils"
    "grep"
    "sed"
    "gawk"
    "file"
    "which"
    
    # Terminal tools
    "less"
    "nano"
    "vim-tiny"
    "tmux"
    
    # System tools
    "procps"
    "htop"
    "tree"
    "locales"
    "iproute2"
    "rsync"
    
    # Other utilities
    "gosu"
    "xdg-utils"
    "sudo"
)

# Ruby specific packages
RUBY_PACKAGES=(
    "libssl-dev"
    "libreadline-dev"
    "zlib1g-dev"
    "libncurses5-dev"
    "libffi-dev"
    "libgdbm-dev"
    "libyaml-dev"
)

# Python specific packages
PYTHON_PACKAGES=(
    "libssl-dev"        # SSL support
    "zlib1g-dev"        # Compression
    "libbz2-dev"        # BZ2 compression
    "libreadline-dev"   # Readline support
    "libsqlite3-dev"    # SQLite support
    "llvm"              # LLVM toolchain
    "libncursesw5-dev"  # NCurses
    "tk-dev"            # Tkinter
    "libxml2-dev"       # XML parsing
    "libxmlsec1-dev"    # XML security
    "libffi-dev"        # Foreign function interface
    "liblzma-dev"       # LZMA compression
)

# Node.js packages (minimal, as we use nvm)
NODEJS_PACKAGES=(
    # Most dependencies are handled by nvm
)

# Go packages (minimal, direct download)
GO_PACKAGES=(
    # Go is self-contained
)

# Rust packages (minimal, rustup handles most)
RUST_PACKAGES=(
    # Rust toolchain is self-contained
)

# Java packages (minimal, direct download)
JAVA_PACKAGES=(
    # Java is self-contained
)

# Function to install packages
install_packages() {
    local packages=("$@")
    if [ ${#packages[@]} -eq 0 ]; then
        return
    fi
    
    print_info "Installing ${#packages[@]} packages..."
    apt-get install -y --no-install-recommends "${packages[@]}"
}

# Function to list packages
list_packages() {
    local category=$1
    shift
    local packages=("$@")
    
    if [ ${#packages[@]} -eq 0 ]; then
        echo "  (No additional packages required)"
        return
    fi
    
    echo "  ${category}:"
    for pkg in "${packages[@]}"; do
        echo "    - $pkg"
    done
}

# Main function
main() {
    local install_mode=false
    local list_mode=false
    
    # Parse arguments
    case "${1:-}" in
        install)
            install_mode=true
            ;;
        list)
            list_mode=true
            ;;
        *)
            echo "Sprite Environment - Language Dependencies Manager"
            echo ""
            echo "This script manages system packages required for language runtimes."
            echo ""
            echo "Usage: $0 [command]"
            echo ""
            echo "Commands:"
            echo "  install  - Install all required packages"
            echo "  list     - List all required packages"
            echo ""
            echo "Note: Installation requires root privileges."
            exit 0
            ;;
    esac
    
    if $list_mode; then
        echo "System packages required for sprite language environments:"
        echo ""
        list_packages "Base packages" "${BASE_PACKAGES[@]}"
        echo ""
        list_packages "Ruby packages" "${RUBY_PACKAGES[@]}"
        echo ""
        list_packages "Python packages" "${PYTHON_PACKAGES[@]}"
        echo ""
        list_packages "Node.js packages" "${NODEJS_PACKAGES[@]}"
        echo ""
        list_packages "Go packages" "${GO_PACKAGES[@]}"
        echo ""
        list_packages "Rust packages" "${RUST_PACKAGES[@]}"
        echo ""
        list_packages "Java packages" "${JAVA_PACKAGES[@]}"
        echo ""
        echo "Total unique packages: $(echo "${BASE_PACKAGES[@]}" "${RUBY_PACKAGES[@]}" "${PYTHON_PACKAGES[@]}" | tr ' ' '\n' | sort -u | wc -l)"
        exit 0
    fi
    
    if $install_mode; then
        check_root
        
        print_info "Starting package installation for sprite language environment..."
        
        # Update package list
        print_info "Updating package list..."
        apt-get update
        
        # Combine all packages and remove duplicates
        ALL_PACKAGES=($(echo "${BASE_PACKAGES[@]}" "${RUBY_PACKAGES[@]}" "${PYTHON_PACKAGES[@]}" "${NODEJS_PACKAGES[@]}" "${GO_PACKAGES[@]}" "${RUST_PACKAGES[@]}" "${JAVA_PACKAGES[@]}" | tr ' ' '\n' | sort -u))
        
        print_info "Installing ${#ALL_PACKAGES[@]} unique packages..."
        install_packages "${ALL_PACKAGES[@]}"
        
        # Generate locale
        print_info "Generating en_US.UTF-8 locale..."
        locale-gen en_US.UTF-8
        
        # Clean up
        print_info "Cleaning up package cache..."
        apt-get clean
        rm -rf /var/lib/apt/lists/*
        
        print_info "Package installation complete!"
        print_info "You can now install languages using the scripts in /.sprite/languages/"
        echo ""
        echo "Available language installers:"
        echo "  - Node.js:  /.sprite/languages/nodejs.sh"
        echo "  - Ruby:     /.sprite/languages/ruby.sh"
        echo "  - Python:   /.sprite/languages/python.sh"
        echo "  - Go:       /.sprite/languages/golang.sh"
        echo "  - Rust:     /.sprite/languages/rust.sh"
        echo "  - Java:     /.sprite/languages/java.sh"
        echo "  - Bun:      /.sprite/languages/bun.sh"
        echo "  - Deno:     /.sprite/languages/deno.sh"
    fi
}

# Run main function
main "$@"
