#!/bin/bash
set -e

# sprite-console: Intelligent shell launcher for sprite console command
#
# This script uses environment variables passed from the client to determine
# which shell to use. It checks if the shell is available, falls back to bash
# if needed, and handles terminfo installation.

# Install terminfo if provided
if [ -n "$SPRITE_TERMINFO_DATA" ]; then
    TERM_NAME="${TERM:-xterm-256color}"
    TERMINFO_DIR="$HOME/.terminfo"
    
    # Extract the first letter for the subdirectory structure
    TERM_LETTER="${TERM_NAME:0:1}"
    TERM_FILE="$TERMINFO_DIR/$TERM_LETTER/$TERM_NAME"
    
    # Only install if it doesn't already exist
    if [ ! -f "$TERM_FILE" ]; then
        mkdir -p "$TERMINFO_DIR/$TERM_LETTER"
        # Decode base64 terminfo data and write to file
        echo "$SPRITE_TERMINFO_DATA" | base64 -d > "$TERM_FILE" 2>/dev/null || true
    fi
fi

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to get login flag for a shell
get_login_flag() {
    local shell_name="$1"
    case "$shell_name" in
        bash|zsh|ksh)
            echo "--login"
            ;;
        fish)
            echo "--login"
            ;;
        tcsh)
            echo "-l"
            ;;
        *)
            echo "--login"
            ;;
    esac
}

# Determine which shell to use based on environment variables
CHOSEN_SHELL=""

# Priority 1: Check shell-specific version variables
if [ -n "$BASH_VERSION" ] && command_exists bash; then
    CHOSEN_SHELL="bash"
elif [ -n "$ZSH_VERSION" ] && command_exists zsh; then
    CHOSEN_SHELL="zsh"
elif [ -n "$FISH_VERSION" ] && command_exists fish; then
    CHOSEN_SHELL="fish"
elif [ -n "$KSH_VERSION" ] && command_exists ksh; then
    CHOSEN_SHELL="ksh"
elif [ -n "$TCSH" ] && command_exists tcsh; then
    CHOSEN_SHELL="tcsh"
fi

# Priority 2: Check SHELL environment variable
if [ -z "$CHOSEN_SHELL" ] && [ -n "$SHELL" ]; then
    # Extract just the shell name from the path
    SHELL_NAME=$(basename "$SHELL")
    if command_exists "$SHELL_NAME"; then
        CHOSEN_SHELL="$SHELL_NAME"
    fi
fi

# Priority 3: Fall back to bash
if [ -z "$CHOSEN_SHELL" ] || ! command_exists "$CHOSEN_SHELL"; then
    if command_exists bash; then
        CHOSEN_SHELL="bash"
    elif command_exists sh; then
        # Last resort: use sh without login flag
        exec sh
        exit 1
    else
        echo "Error: No suitable shell found" >&2
        exit 1
    fi
fi

# Get the appropriate login flag for the chosen shell
LOGIN_FLAG=$(get_login_flag "$CHOSEN_SHELL")

# Execute the chosen shell with login flag
exec "$CHOSEN_SHELL" "$LOGIN_FLAG"

