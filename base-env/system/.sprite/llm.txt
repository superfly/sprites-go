# Sprite Environment

## User Account
- Runs as `sprite` user
- Passwordless sudo access enabled

## Lifecycle
- Sprites run while actively servicing HTTP requests
- Sprites run while detachable sessions are generating output
- When neither condition is true, sprites pause
- Sprites may remain paused or be fully stopped at any time
- When stopped, detachable sessions are lost
- Services restart automatically at boot time

## Services
- Long-running processes that persist between reboots
- Managed through the internal API
- Automatically restarted when sprite boots

## Checkpoints
- Point-in-time checkpoints and restores available
- Copy-on-write implementation for storage efficiency
- Last 5 checkpoints mounted at `/.sprite/checkpoints`
- Checkpoints capture only the writable overlay, not the base image

## File System
- Base Docker image with writable overlay
- Underlying image upgraded out-of-band without modifying overlay
- All modifications stored in overlay layer

## Internal API
- Unix socket at `/.sprite/api.sock`
- Manages environment, checkpoints, and services
- Run `curl-sprite-api --help` for endpoint documentation

## Development Tools
- If `llm-dev.txt` exists, it documents pre-installed language runtimes, version managers, and dev tools

## Network Policy

### Overview
Sprite environments enforce network egress policy through DNS-based filtering. Only allowed domains can be resolved and accessed.

### Viewing Current Policy
The active policy is read-only and mounted at:
```bash
cat /.sprite/policy/network.json
```

### Policy Format
Policies are JSON with a list of rules evaluated by specificity (exact match > subdomain wildcard > global wildcard):

```json
{
  "rules": [
    {"include": "defaults"},
    {"domain": "example.com", "action": "allow"},
    {"domain": "*.example.com", "action": "allow"},
    {"domain": "blocked.com", "action": "deny"}
  ]
}
```

**Include Rules**: `{"include": "defaults"}` loads common development domains (GitHub, npm, PyPI, Docker Hub, AI APIs like OpenAI/Claude/Copilot, etc.)

**Domain Rules**: Support exact matches, subdomain wildcards (`*.example.com`), and global wildcard (`*`)

**Empty Rules**: `{"rules": []}` means no enforcement (unrestricted mode)

### Updating Policy
**Network policies MUST be updated externally** - the container cannot modify its own policy.

Update via the Sprite API from outside the container:
```bash
curl -X POST https://your-sprite.fly.dev/v1/sprites/{id}/policy/network \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"rules": [{"include": "defaults"}]}'
```

Policy changes reload automatically and terminate existing connections to newly-blocked domains.

### Behavior
- **Denied domains**: DNS returns REFUSED (fast-fail)
- **Raw IP connections**: Blocked unless the IP was resolved from an allowed domain
- **Private IPs**: Always blocked (except DNS to host)
- **Existing connections**: Terminated when policy changes via conntrack flush

### Troubleshooting
Test DNS resolution:
```bash
dig allowed-domain.com    # Should resolve
dig blocked-domain.com    # Returns REFUSED
```

