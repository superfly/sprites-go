# Get JuiceFS binary from the custom superfly image
FROM ghcr.io/superfly/juicefs:fname as juicefs

# Test image for JuiceFS package
FROM golang:1.24.4-alpine AS builder

# Install build dependencies
RUN apk add --no-cache \
    git \
    gcc \
    musl-dev \
    sqlite-dev \
    fuse3-dev \
    fuse3 \
    bash \
    ca-certificates \
    e2fsprogs \
    util-linux

# Copy JuiceFS binary from the custom image
COPY --from=juicefs /usr/local/bin/juicefs /usr/local/bin/juicefs

# Install Litestream
RUN wget -q https://github.com/benbjohnson/litestream/releases/download/v0.3.13/litestream-v0.3.13-linux-amd64.tar.gz && \
    tar -xzf litestream-v0.3.13-linux-amd64.tar.gz && \
    mv litestream /usr/local/bin/ && \
    rm -f litestream-v0.3.13-linux-amd64.tar.gz && \
    chmod +x /usr/local/bin/litestream

# Create directory structure
RUN mkdir -p /workspace/server/packages/juicefs

# Set working directory
WORKDIR /workspace/server/packages/juicefs

# Copy go.mod and go.sum files for dependency caching
COPY packages/juicefs/go.mod packages/juicefs/go.sum ./

# Download dependencies
RUN go mod download

# Now copy the source code
COPY packages/juicefs/ ./

# Enable FUSE (required for JuiceFS mount)
RUN echo "user_allow_other" >> /etc/fuse.conf

# Create symlink for fusermount (JuiceFS expects fusermount but Alpine has fusermount3)
RUN ln -s /usr/bin/fusermount3 /bin/fusermount

# Run tests with coverage (including integration tests with build tag) as root
CMD ["go", "test", "-v", "-race", "-tags=integration", "-coverprofile=coverage.out", "-covermode=atomic", "-run", "^Test", "./..."]