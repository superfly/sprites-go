<!-- 15983813-2772-4c81-ac9a-52cd67e097db 9380fadb-edc4-4d80-b4dc-b232fc719401 -->
# Procedural Exec Handler + Runner Integration Plan

## Scope

- Add a new `server/api/exec.go` implementing a procedural exec handler (no errgroup, no websocket monitor).
- Update `pkg/runner` to expose async `Run()`, blocking `PID()` and `Wait()`, and internal I/O pumping.
- Keep `server/api/exec_terminal.go` and current routing unchanged; no swap yet.

## Files to Create

- `server/api/exec.go`: Procedural exec handler using `pkg/runner`, `wsReader`/`wsWriter`, and optional mux in non-TTY.
- `server/system/wrap.go`: `(*System).WrapContainer(*exec.Cmd, bool) *exec.Cmd` (no-op when not containerized).

## Files to Modify

- `pkg/runner/runner.go`: Add `pidReady`, implement `Run()` (async start), `Wait()` (blocking/drain), `PID()` (block until set), `ExitCode()` storage, `Resize()`.
- `pkg/runner/run_tty_unix.go`: Set `pidReady` immediately after successful `cmd.Start()`, wire PTY I/O, ensure drain before return.
- `pkg/runner/run_non_tty.go`: Start process, set `pidReady`, wire pipes, ensure drain and exit code capture.
- `pkg/runner/multiplexer.go`: Ensure synchronous writes and `WriteExit(code)` helper; keep stream IDs local to this package.
- `pkg/container/wrap.go`: Add `GetPTYFunc(socketPath)` helper if missing (used when containerized TTY requires late PTY).

## Execution Steps

1. Update runner core:

- Introduce `pidReady` state and implement `PID()` blocking on readiness.
- Implement `Run()` to start the process and return immediately on success.
- Implement `Wait()` to block on process completion and I/O goroutines; store exit code.

2. Update run paths:

- In non-TTY, pipe stdin/stdout/stderr as direct pipes; set `pidReady` after `cmd.Start()`.
- In TTY, allocate or wait for PTY, wire I/O via master; set `pidReady` after `cmd.Start()`.
- Support control-only TTY stdin consumption (read and discard) when stdin disabled.

3. Multiplexer verification:

- Ensure stdout/stderr writes are serialized and synchronous.
- Provide `WriteExit(code)` for non-TTY exit signaling.
- Keep stream ID constants internal to `pkg/runner`.

4. Container/system wrappers:

- Add `server/system/wrap.go` to wrap a command in container context (no-op when not applicable).
- Add/verify `pkg/container/wrap.go` `GetPTYFunc` helper for deferred PTY acquisition.

5. New handler (`server/api/exec.go`):

- Upgrade WebSocket.
- Build base `exec.Cmd`; apply `system.WrapContainer(..., tty)`.
- Create adapters: `wsReader` (handles text resize) and `wsWriter` (mutexed writes).
- For non-TTY, wrap writer in `runner.MultiplexedWriter` for stdout/stderr/exit.
- Construct runner; call `Run()` (async), then `PID()` (block until set) and register with `portWatcher` if present.
- Call `Wait()`; on non-TTY, write exit via mux; then close WebSocket.
- Remove any sleeps or websocket monitor usage.

6. Keep existing behavior:

- Do not modify `server/api/exec_terminal.go`.
- Do not change routing to point to the new handler yet.

## Validation

- Verify no output loss on client disconnect or process exit.
- Ensure `PID()` blocks correctly without sleeps.
- Confirm non-TTY exit signaling is sent before closing the WebSocket.
- Confirm TTY resizes via text control are applied.
- Run the test suite and basic manual checks; no long-running processes.

## Rollout

- Land changes behind the new file without altering routes.
- Plan a follow-up to switch routing to the new handler once validated.

## Future Work

- Port watcher (direct): Instantiate and manage a `PortWatcher` in `server/api/exec.go` after `PID()`; add/remove PID; ensure lifecycle (Start/Stop) is tied to the websocket session.
- TMUX detachable: Add `detachable` and `cc` query params support in `exec.go` to create/attach sessions via TMUX manager; keep behavior consistent with `exec_terminal.go`.

### To-dos

- [x] Add pidReady and blocking PID() in pkg/runner
- [x] Implement async Run() and blocking Wait() with exit code
- [x] Honor TTY control-only stdin consumption
- [ ] Verify multiplexer sync writes and add WriteExit(code)
- [x] Add GetPTYFunc in pkg/container/wrap.go if missing
- [x] Add WrapContainer in server/system/wrap.go
- [x] Create server/api/exec.go procedural handler
- [x] Leave exec_terminal.go and routes unchanged
- [ ] Run test suite and basic manual checks
- [ ] Validate close semantics, large output drain, resize