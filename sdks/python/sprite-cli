#!/usr/bin/env python3
"""
Thin CLI wrapper for the Sprite Python SDK.
This is a minimal shim that maps CLI args to SDK calls.
"""

import sys
import os
import json
from sprites import SpritesClient
from sprites.exceptions import SpritesError


def main():
    if len(sys.argv) < 2:
        print_usage()
        sys.exit(1)
    
    # Get environment variables
    url = os.environ.get("SPRITE_URL")
    token = os.environ.get("SPRITE_TOKEN")
    
    if not url:
        print("Error: SPRITE_URL environment variable not set", file=sys.stderr)
        sys.exit(1)
    
    if not token:
        print("Error: SPRITE_TOKEN environment variable not set", file=sys.stderr)
        sys.exit(1)
    
    # Remove trailing slash from URL
    url = url.rstrip("/")
    
    # Create client
    client = SpritesClient(endpoint=url, token=token)
    
    # For CLI compatibility, we use a fixed sprite ID like the tests do
    sprite = client.attach("cli-sprite")
    
    # Parse command
    command = sys.argv[1]
    
    try:
        if command == "exec":
            exec_command(sprite, sys.argv[2:])
        elif command in ["checkpoint", "checkpoints", "c"]:
            checkpoint_command(sprite, sys.argv[2:])
        elif command == "restore":
            restore_command(sprite, sys.argv[2:])
        elif command == "admin":
            admin_command(sprite, sys.argv[2:])
        elif command in ["help", "-h", "--help"]:
            print_usage()
            sys.exit(0)
        else:
            print(f"Error: Unknown command '{command}'", file=sys.stderr)
            print()
            print_usage()
            sys.exit(1)
    except SpritesError as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)


def print_usage():
    print("""sprite-client - Sprite Environment API Client

Usage:
  sprite-client <command> [arguments]

Commands:
  exec                      Execute a command in the sprite environment
  checkpoint <subcommand>   Manage checkpoints (aliases: checkpoints, c)
    create                  Create a new checkpoint
    list                    List all checkpoints
    info <id>               Show information about a specific checkpoint
  restore <id>              Restore from a checkpoint

Environment Variables:
  SPRITE_URL    Base URL of the Sprite API (required)
  SPRITE_TOKEN  Authentication token (required)
  SPRITE_ADMIN_TOKEN  Admin authentication token (optional, for admin commands)

Examples:
  # Execute a command
  sprite-client exec ls -la

  # Create a checkpoint
  sprite-client checkpoint create

  # List checkpoints
  sprite-client checkpoint list

  # Get checkpoint info
  sprite-client checkpoint info v3

  # Restore from checkpoint
  sprite-client restore my-checkpoint-id

Use 'sprite-client exec -h' for exec command options.""", file=sys.stderr)


def exec_command(sprite, args):
    # Simple arg parsing for exec
    working_dir = None
    env = {}
    tty = False
    cmd_args = []
    
    i = 0
    while i < len(args):
        if args[i] == "-dir" and i + 1 < len(args):
            working_dir = args[i + 1]
            i += 2
        elif args[i] == "-env" and i + 1 < len(args):
            # Parse env as KEY=value,KEY2=value2
            env_str = args[i + 1]
            for pair in env_str.split(","):
                if "=" in pair:
                    key, value = pair.split("=", 1)
                    env[key.strip()] = value.strip()
            i += 2
        elif args[i] == "-tty":
            tty = True
            i += 1
        elif args[i] in ["-h", "--help"]:
            print_exec_usage()
            sys.exit(0)
        else:
            # Rest are command args
            cmd_args = args[i:]
            break
    
    if not cmd_args:
        print("Error: No command specified", file=sys.stderr)
        print()
        print_exec_usage()
        sys.exit(1)
    
    # Execute command using sprite API
    exec_cmd = sprite.exec(
        cmd=cmd_args,
        cwd=working_dir,
        env=env,
        tty=tty
    )
    
    # Run the command and get result
    # Only read stdin if it's available and not a terminal
    stdin_data = None
    if not tty and not sys.stdin.isatty():
        try:
            stdin_data = sys.stdin.read()
        except:
            pass
    
    result = exec_cmd.run(stdin=stdin_data)
    
    # Print output
    if result.stdout:
        sys.stdout.buffer.write(result.stdout)
        sys.stdout.flush()
    if result.stderr:
        sys.stderr.buffer.write(result.stderr)
        sys.stderr.flush()
    
    sys.exit(result.returncode if result.returncode is not None else 0)


def print_exec_usage():
    print("""Usage: sprite-client exec [options] command [args...]

Execute a command in the sprite environment.

Options:
  -dir string     Working directory for the command
  -tty            Allocate a pseudo-TTY
  -env string     Environment variables (KEY=value,KEY2=value2)
  -h              Show help

Examples:
  sprite-client exec ls -la
  sprite-client exec -dir /app echo hello world
  sprite-client exec -env KEY=value,FOO=bar env
  sprite-client exec -tty /bin/bash""", file=sys.stderr)


def checkpoint_command(sprite, args):
    if not args:
        print("Error: checkpoint requires a subcommand", file=sys.stderr)
        print("Usage: sprite-client checkpoint <create|list|info> [arguments]", file=sys.stderr)
        sys.exit(1)
    
    subcommand = args[0]
    sub_args = args[1:]
    
    if subcommand == "create":
        checkpoint_create_command(sprite, sub_args)
    elif subcommand == "list":
        checkpoint_list_command(sprite, sub_args)
    elif subcommand == "info":
        checkpoint_info_command(sprite, sub_args)
    else:
        print(f"Error: Unknown checkpoint subcommand '{subcommand}'", file=sys.stderr)
        print("Usage: sprite-client checkpoint <create|list|info> [arguments]", file=sys.stderr)
        sys.exit(1)


def checkpoint_create_command(sprite, args):
    if args:
        print("Error: checkpoint create takes no arguments", file=sys.stderr)
        print("Usage: sprite-client checkpoint create", file=sys.stderr)
        sys.exit(1)
    
    # Collect messages for output
    messages = []
    checkpoint_id = None
    
    def on_message(msg):
        nonlocal checkpoint_id
        if msg.type == "info":
            print(msg.message)
        elif msg.type == "stdout":
            print(msg.message)
        elif msg.type == "stderr":
            print(msg.message, file=sys.stderr)
        elif msg.type == "error":
            print(f"Error: {msg.error or msg.message}", file=sys.stderr)
        elif msg.type == "complete":
            print(msg.message)
            if hasattr(msg, 'data') and 'checkpoint_id' in msg.data:
                checkpoint_id = msg.data['checkpoint_id']
        messages.append(msg)
    
    success = sprite.checkpoint(on_message=on_message)
    if success:
        print(f"Checkpoint created successfully with ID: {checkpoint_id if checkpoint_id else 'unknown'}")


def checkpoint_list_command(sprite, args):
    checkpoints = sprite.list_checkpoints()
    
    if not checkpoints:
        print("No checkpoints found.")
        return
    
    print(f"{'ID':<30} {'CREATED'}")
    print(f"{'-'*30} {'-'*25}")
    
    for cp in checkpoints:
        created = cp.create_time.isoformat() if hasattr(cp.create_time, 'isoformat') else str(cp.create_time)
        print(f"{cp.id:<30} {created}")


def checkpoint_info_command(sprite, args):
    if len(args) != 1:
        print("Error: checkpoint info requires exactly one argument (checkpoint ID)", file=sys.stderr)
        print("Usage: sprite-client checkpoint info <checkpoint-id>", file=sys.stderr)
        sys.exit(1)
    
    checkpoint_id = args[0]
    info = sprite.get_checkpoint(checkpoint_id)
    
    print(f"ID: {info.id}")
    print(f"Created: {info.create_time.isoformat() if hasattr(info.create_time, 'isoformat') else str(info.create_time)}")
    
    history = info.history
    if history:
        print("History:")
        for entry in history:
            print(f"  {entry}")
    else:
        print("History: (none)")


def restore_command(sprite, args):
    if len(args) != 1:
        print("Error: restore requires exactly one argument (checkpoint ID)", file=sys.stderr)
        print("Usage: sprite-client restore <checkpoint-id>", file=sys.stderr)
        sys.exit(1)
    
    checkpoint_id = args[0]
    
    # Show progress messages
    completed = False
    def on_message(msg):
        nonlocal completed
        if msg.type == "info":
            print(msg.message)
        elif msg.type == "stdout":
            print(msg.message)
        elif msg.type == "stderr":
            print(msg.message, file=sys.stderr)
        elif msg.type == "error":
            print(f"Error: {msg.error or msg.message}", file=sys.stderr)
        elif msg.type == "complete":
            print(msg.message)
            completed = True
    
    success = sprite.restore(checkpoint_id, on_message=on_message)
    if success and not completed:
        print("Restore completed successfully")


def admin_command(sprite, args):
    if not args:
        print("Error: admin requires a subcommand", file=sys.stderr)
        print("Usage: sprite-client admin <reset-state> [arguments]", file=sys.stderr)
        sys.exit(1)
    
    subcommand = args[0]
    sub_args = args[1:]
    
    if subcommand == "reset-state":
        admin_reset_state_command(sprite, sub_args)
    else:
        print(f"Error: Unknown admin subcommand '{subcommand}'", file=sys.stderr)
        print("Usage: sprite-client admin <reset-state> [arguments]", file=sys.stderr)
        sys.exit(1)


def admin_reset_state_command(sprite, args):
    if args:
        print("Error: admin reset-state takes no arguments", file=sys.stderr)
        print("Usage: sprite-client admin reset-state", file=sys.stderr)
        sys.exit(1)
    
    # For admin commands, we need to make direct HTTP request since SDK doesn't have reset_state
    import requests
    
    url = sprite.client.endpoint + "/admin/reset-state"
    token = os.environ.get("SPRITE_ADMIN_TOKEN", sprite.client.token)
    headers = {"Authorization": f"Bearer {token}"}
    
    try:
        response = requests.post(url, headers=headers)
        if response.status_code == 200:
            print("State reset successfully")
        elif response.status_code == 403:
            print("Error: Admin authentication required. Set SPRITE_ADMIN_TOKEN environment variable.", file=sys.stderr)
            sys.exit(1)
        else:
            print(f"Error: API returned status {response.status_code}: {response.text}", file=sys.stderr)
            sys.exit(1)
    except Exception as e:
        print(f"Error: Failed to reset state: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()