name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'
  workflow_dispatch:

jobs:
  context:
    name: Compute context
    runs-on:
      group: sprite-env-amd64
    outputs:
      is_main_run: ${{ steps.flags.outputs.is_main_run }}
      sha: ${{ steps.sha.outputs.sha }}
      short_sha: ${{ steps.sha.outputs.short_sha }}
      ref_name: ${{ steps.ref.outputs.ref_name }}
      tag_suffix: ${{ steps.suffix.outputs.tag_suffix }}
      tag_latest: ${{ steps.flags.outputs.tag_latest }}
      # releaser context
      ubuntu_tag: ${{ steps.ctx.outputs.ubuntu_tag }}
      sprite_env_tag: ${{ steps.ctx.outputs.sprite_env_tag }}
      is_version_tag: ${{ steps.ctx.outputs.is_version_tag }}
      previous_tag: ${{ steps.ctx.outputs.previous_tag }}
      tag_latest_server: ${{ steps.ctx.outputs.tag_latest_server }}
      client_upload_prefix: ${{ steps.ctx.outputs.client_upload_prefix }}
      client_channel_file: ${{ steps.ctx.outputs.client_channel_file }}
      client_channel_value: ${{ steps.ctx.outputs.client_channel_value }}
      # images plan
      base_action: ${{ steps.pl.outputs.base_action }}
      base_source_tag: ${{ steps.pl.outputs.base_source_tag }}
      base_target_tag: ${{ steps.pl.outputs.base_target_tag }}
      base_latest_tag: ${{ steps.pl.outputs.base_latest_tag }}
      languages_action: ${{ steps.pl.outputs.languages_action }}
      languages_source_tag: ${{ steps.pl.outputs.languages_source_tag }}
      languages_target_tag: ${{ steps.pl.outputs.languages_target_tag }}
      languages_latest_tag: ${{ steps.pl.outputs.languages_latest_tag }}
      server_tag: ${{ steps.pl.outputs.server_tag }}
    steps:
    - name: Determine triggering context
      id: flags
      run: |
        # workflow_dispatch on main/dev-release means triggered by Tests workflow
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && \
           { [[ "${{ github.ref_name }}" == "main" ]] || [[ "${{ github.ref_name }}" == "dev-release" ]]; }; then
          echo "is_main_run=true" >> $GITHUB_OUTPUT
          echo "tag_latest=false" >> $GITHUB_OUTPUT
        # Push with tag (version release)
        elif [[ "${{ github.ref_type }}" == "tag" ]]; then
          echo "is_main_run=false" >> $GITHUB_OUTPUT
          # Tag latest on true version tags without suffix (e.g., v1.2.3, not v1.2.3-beta)
          echo "tag_latest=${{ !contains(github.ref_name, '-') }}" >> $GITHUB_OUTPUT
        # Manual workflow_dispatch on non-main/dev-release branches
        else
          echo "is_main_run=false" >> $GITHUB_OUTPUT
          echo "tag_latest=false" >> $GITHUB_OUTPUT
        fi
    - name: Compute SHA and ref
      id: sha
      run: |
        echo "sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT
        echo "short_sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
    - name: Compute ref name
      id: ref
      run: |
        echo "ref_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
    - name: Compute tag suffix
      id: suffix
      run: |
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GH_PAT || github.token }}
        fetch-depth: 0
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'
    - name: Prepare modules (populate go.sum)
      run: |
        go env -w GOFLAGS=
        go mod tidy
    - name: Derive release context (releaser)
      id: ctx
      run: |
        go run ./tools/releaser context --gha-outputs --distro 25.04
    - name: Plan images (releaser)
      id: pl
      run: |
        go run ./tools/releaser images plan --gha-outputs --registry ghcr.io --ubuntu-image superfly/sprite-ubuntu --distro 25.04
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
          echo "tag_suffix=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        elif [[ "${{ steps.flags.outputs.is_main_run }}" == "true" ]]; then
          echo "tag_suffix=dev-${{ steps.sha.outputs.short_sha }}" >> $GITHUB_OUTPUT
        else
          echo "tag_suffix=" >> $GITHUB_OUTPUT
        fi
  # test:
  #   name: Run Tests
  #   uses: ./.github/workflows/test.yml

  release-images:
    name: Release Docker Images
    needs: [context]
    if: ${{ github.ref_type == 'tag' || needs.context.outputs.is_main_run == 'true' }}
    uses: ./.github/workflows/release-images.yml
    permissions:
      contents: read
      packages: write
    secrets: inherit

  release-server-image:
    name: Release Docker Images / build-sprite-env
    needs: [context]
    if: ${{ github.ref_type == 'tag' || needs.context.outputs.is_main_run == 'true' }}
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/docker-publish.yml
    with:
      context_dir: .
      dockerfile: ./Dockerfile
      tag: ${{ needs.context.outputs.server_tag }}
      image_name: superfly/sprite-env
      cache_tag: latest
      latest_tag: latest
      tag_latest: ${{ needs.context.outputs.tag_latest_server == 'true' }}
      version: ${{ needs.context.outputs.is_version_tag == 'true' && github.ref_name || '' }}
      git_sha: ${{ needs.context.outputs.is_version_tag == 'false' && needs.context.outputs.short_sha || '' }}
    secrets: inherit

  release-client:
    name: Release Client
    needs: [context]
    uses: ./.github/workflows/release-client.yml
    permissions:
      contents: write 
    secrets: inherit
    if: ${{ github.ref_type == 'tag' || needs.context.outputs.is_main_run == 'true' }}
    with:
      upload_prefix: ${{ needs.context.outputs.client_upload_prefix }}
      channel_file: ${{ needs.context.outputs.client_channel_file }}
      channel_value: ${{ needs.context.outputs.client_channel_value }}