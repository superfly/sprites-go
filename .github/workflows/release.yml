name: Release Docker Images

on:
  workflow_dispatch:
    inputs:
      tag_suffix:
        description: 'Tag suffix to append to 25.04 (defaults to short commit ID)'
        required: false
        default: ''
        type: string
      tag_latest:
        description: 'Also tag as latest'
        required: false
        type: boolean
        default: true
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: superfly/sprite-ubuntu

jobs:
  generate-tag:
    runs-on: ubuntu-latest
    outputs:
      ubuntu_tag: ${{ steps.tag.outputs.ubuntu_tag }}
      sprite_env_tag: ${{ steps.tag.outputs.sprite_env_tag }}
      is_version_tag: ${{ steps.tag.outputs.is_version_tag }}
    steps:
    - name: Generate short SHA
      id: short-sha
      run: echo "short-sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
    
    - name: Generate tags
      id: tag
      run: |
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
          # Strip the 'v' prefix from version tags
          TAG="${{ github.ref_name }}"
          TAG="${TAG#v}"
          echo "ubuntu_tag=25.04-${TAG}" >> $GITHUB_OUTPUT
          echo "sprite_env_tag=${TAG}" >> $GITHUB_OUTPUT
          echo "is_version_tag=true" >> $GITHUB_OUTPUT
        else
          SUFFIX="${{ inputs.tag_suffix || steps.short-sha.outputs.short-sha }}"
          echo "ubuntu_tag=25.04-${SUFFIX}" >> $GITHUB_OUTPUT
          echo "sprite_env_tag=${SUFFIX}" >> $GITHUB_OUTPUT
          echo "is_version_tag=false" >> $GITHUB_OUTPUT
        fi

  build-base:
    needs: generate-tag
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/docker-publish.yml
    with:
      context_dir: base-env/images/ubuntu-devtools
      dockerfile: base-env/images/ubuntu-devtools/Dockerfile
      tag: ${{ needs.generate-tag.outputs.ubuntu_tag }}
      image_name: superfly/sprite-ubuntu
      cache_tag: 25.04-latest
      latest_tag: 25.04-latest
      tag_latest: ${{ needs.generate-tag.outputs.is_version_tag == 'false' && (inputs.tag_latest == true || inputs.tag_latest == null) }}

  build-languages:
    needs: [generate-tag, build-base]
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/docker-publish.yml
    with:
      context_dir: base-env/images/ubuntu-devtools
      dockerfile: base-env/images/ubuntu-devtools/Dockerfile
      tag: ${{ needs.generate-tag.outputs.ubuntu_tag }}-languages
      image_name: superfly/sprite-ubuntu
      target: languages
      cache_tag: 25.04-languages-latest
      latest_tag: 25.04-languages-latest
      tag_latest: ${{ needs.generate-tag.outputs.is_version_tag == 'false' && (inputs.tag_latest == true || inputs.tag_latest == null) }}

  build-sprite-env:
    needs: generate-tag
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/docker-publish.yml
    with:
      context_dir: .
      dockerfile: ./Dockerfile
      tag: ${{ needs.generate-tag.outputs.sprite_env_tag }}
      image_name: superfly/sprite-env
      cache_tag: latest
      latest_tag: latest
      tag_latest: ${{ needs.generate-tag.outputs.is_version_tag == 'false' && (inputs.tag_latest == true || inputs.tag_latest == null) }}