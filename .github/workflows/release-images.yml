name: Release Docker Images

on:
  workflow_dispatch:
    inputs:
      tag_suffix:
        description: 'Tag suffix to append to 25.04 (defaults to short commit ID)'
        required: false
        default: ''
        type: string
      tag_latest:
        description: 'Also tag as latest'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      tag_suffix:
        description: 'Tag suffix to append to 25.04 (defaults to short commit ID)'
        required: false
        default: ''
        type: string
      tag_latest:
        description: 'Also tag as latest'
        required: false
        type: boolean
        default: true
      checkout_ref:
        description: 'Git ref/sha to check out when called from workflow_run'
        required: false
        default: ''
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: superfly/sprite-ubuntu

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      ubuntu_tag: ${{ steps.ctx.outputs.ubuntu_tag }}
      sprite_env_tag: ${{ steps.ctx.outputs.sprite_env_tag }}
      is_version_tag: ${{ steps.ctx.outputs.is_version_tag }}
      previous_tag: ${{ steps.ctx.outputs.previous_tag }}
      short_sha: ${{ steps.ctx.outputs.short-sha }}
      tag_latest_server: ${{ steps.ctx.outputs.tag_latest_server }}
      base_action: ${{ steps.pl.outputs.base_action }}
      base_source_tag: ${{ steps.pl.outputs.base_source_tag }}
      base_target_tag: ${{ steps.pl.outputs.base_target_tag }}
      base_latest_tag: ${{ steps.pl.outputs.base_latest_tag }}
      languages_action: ${{ steps.pl.outputs.languages_action }}
      languages_source_tag: ${{ steps.pl.outputs.languages_source_tag }}
      languages_target_tag: ${{ steps.pl.outputs.languages_target_tag }}
      languages_latest_tag: ${{ steps.pl.outputs.languages_latest_tag }}
      server_tag: ${{ steps.pl.outputs.server_tag }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GH_PAT || github.token }}
        fetch-depth: 0
        ref: ${{ inputs.checkout_ref != '' && inputs.checkout_ref || github.ref }}

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Prepare modules (populate go.sum)
      run: |
        go env -w GOFLAGS=
        go mod tidy

    - name: Compute context
      id: ctx
      run: |
        go run ./tools/releaser context --gha-outputs --distro 25.04

    - name: Plan images
      id: pl
      run: |
        go run ./tools/releaser images plan --gha-outputs --registry ghcr.io --ubuntu-image superfly/sprite-ubuntu --distro 25.04

  build-or-retag-base:
    needs: [plan]
    permissions:
      contents: read
      packages: write
    if: needs.plan.outputs.base_action == 'build'
    uses: ./.github/workflows/docker-publish.yml
    with:
      context_dir: base-env/images/ubuntu-devtools
      dockerfile: base-env/images/ubuntu-devtools/Dockerfile
      tag: ${{ needs.plan.outputs.base_target_tag }}
      image_name: superfly/sprite-ubuntu
      version: ${{ needs.plan.outputs.is_version_tag == 'true' && github.ref_name || '' }}
      git_sha: ${{ needs.plan.outputs.is_version_tag == 'false' && needs.plan.outputs.short_sha || '' }}
      cache_tag: 25.04-latest
      latest_tag: 25.04-latest
      tag_latest: ${{ needs.plan.outputs.base_latest_tag != '' }}
    secrets: inherit

  retag-base:
    needs: [plan]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    if: needs.plan.outputs.base_action == 'retag'
    steps:
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Retag existing image
      run: |
        SOURCE_TAG="${{ needs.plan.outputs.base_source_tag }}"
        TARGET_TAG="${{ needs.plan.outputs.base_target_tag }}"
        
        echo "Retagging ${SOURCE_TAG} as ${TARGET_TAG}..."
        
        # Create manifest for multi-arch retagging
        docker buildx imagetools create \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TARGET_TAG} \
          ${{ needs.plan.outputs.base_latest_tag != '' && format('-t {0}/{1}:{2}', env.REGISTRY, env.IMAGE_NAME, needs.plan.outputs.base_latest_tag) || '' }} \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SOURCE_TAG}

  build-or-retag-languages:
    needs: [plan, build-or-retag-base, retag-base]
    if: always() && (needs.build-or-retag-base.result == 'success' || needs.retag-base.result == 'success') && needs.plan.outputs.languages_action == 'build'
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/docker-publish.yml
    with:
      context_dir: base-env/images/ubuntu-devtools
      dockerfile: base-env/images/ubuntu-devtools/Dockerfile
      tag: ${{ needs.plan.outputs.languages_target_tag }}
      image_name: superfly/sprite-ubuntu
      target: languages
      cache_tag: 25.04-languages-latest
      latest_tag: 25.04-languages-latest
      tag_latest: ${{ needs.plan.outputs.languages_latest_tag != '' }}
      version: ${{ needs.plan.outputs.is_version_tag == 'true' && github.ref_name || '' }}
      git_sha: ${{ needs.plan.outputs.is_version_tag == 'false' && needs.plan.outputs.short_sha || '' }}
    secrets: inherit

  retag-languages:
    needs: [plan, build-or-retag-base, retag-base]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    if: always() && (needs.build-or-retag-base.result == 'success' || needs.retag-base.result == 'success') && needs.plan.outputs.languages_action == 'retag'
    steps:
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Retag existing languages image
      run: |
        SOURCE_TAG="${{ needs.plan.outputs.languages_source_tag }}"
        TARGET_TAG="${{ needs.plan.outputs.languages_target_tag }}"
        
        echo "Retagging ${SOURCE_TAG} as ${TARGET_TAG}..."
        
        # Create manifest for multi-arch retagging
        docker buildx imagetools create \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TARGET_TAG} \
          ${{ needs.plan.outputs.languages_latest_tag != '' && format('-t {0}/{1}:{2}', env.REGISTRY, env.IMAGE_NAME, needs.plan.outputs.languages_latest_tag) || '' }} \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SOURCE_TAG}

  build-sprite-env:
    needs: plan
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/docker-publish.yml
    with:
      context_dir: .
      dockerfile: ./Dockerfile
      tag: ${{ needs.plan.outputs.server_tag }}
      image_name: superfly/sprite-env
      cache_tag: latest
      latest_tag: latest
      tag_latest: ${{ needs.plan.outputs.tag_latest_server == 'true' }}
      version: ${{ needs.plan.outputs.is_version_tag == 'true' && github.ref_name || '' }}
      git_sha: ${{ needs.plan.outputs.is_version_tag == 'false' && needs.plan.outputs.short_sha || '' }}
    secrets: inherit