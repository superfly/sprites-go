name: Release Docker Images

on:
  workflow_dispatch:
    inputs:
      tag_suffix:
        description: 'Tag suffix to append to 25.04 (defaults to short commit ID)'
        required: false
        default: ''
        type: string
      tag_latest:
        description: 'Also tag as latest'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      tag_suffix:
        description: 'Tag suffix to append to 25.04 (defaults to short commit ID)'
        required: false
        default: ''
        type: string
      tag_latest:
        description: 'Also tag as latest'
        required: false
        type: boolean
        default: true
      checkout_ref:
        description: 'Git ref/sha to check out when called from workflow_run'
        required: false
        default: ''
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: superfly/sprite-ubuntu

jobs:
  generate-tag:
    runs-on: ubuntu-latest
    outputs:
      ubuntu_tag: ${{ steps.tag.outputs.ubuntu_tag }}
      sprite_env_tag: ${{ steps.tag.outputs.sprite_env_tag }}
      is_version_tag: ${{ steps.tag.outputs.is_version_tag }}
      previous_tag: ${{ steps.tag.outputs.previous_tag }}
      short_sha: ${{ steps.short-sha.outputs.short-sha }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GH_PAT || github.token }}
        fetch-depth: 0  # Fetch all history for tags
        ref: ${{ inputs.checkout_ref != '' && inputs.checkout_ref || github.ref }}
    
    - name: Generate short SHA
      id: short-sha
      run: echo "short-sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
    
    - name: Generate tags
      id: tag
      run: |
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
          # Strip the 'v' prefix from version tags
          TAG="${{ github.ref_name }}"
          TAG="${TAG#v}"
          echo "ubuntu_tag=25.04-${TAG}" >> $GITHUB_OUTPUT
          echo "sprite_env_tag=${TAG}" >> $GITHUB_OUTPUT
          echo "is_version_tag=true" >> $GITHUB_OUTPUT
          
          # Get previous tag for comparison
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [[ ! -z "$PREV_TAG" ]]; then
            PREV_TAG="${PREV_TAG#v}"
          fi
          echo "previous_tag=${PREV_TAG}" >> $GITHUB_OUTPUT
        else
          SUFFIX="${{ inputs.tag_suffix || steps.short-sha.outputs.short-sha }}"
          echo "ubuntu_tag=25.04-${SUFFIX}" >> $GITHUB_OUTPUT
          echo "sprite_env_tag=${SUFFIX}" >> $GITHUB_OUTPUT
          echo "is_version_tag=false" >> $GITHUB_OUTPUT
          echo "previous_tag=" >> $GITHUB_OUTPUT
        fi

  check-ubuntu-changes:
    needs: generate-tag
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
      source_tag: ${{ steps.check.outputs.source_tag }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GH_PAT || github.token }}
        fetch-depth: 0  # Fetch all history for comparison
        ref: ${{ inputs.checkout_ref != '' && inputs.checkout_ref || github.ref }}
    
    - name: Check for changes in ubuntu-devtools
      id: check
      run: |
        # Only check for changes if we have a previous tag
        if [[ -z "${{ needs.generate-tag.outputs.previous_tag }}" ]]; then
          echo "No previous tag found, will build images"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "source_tag=" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Compare changes since the previous tag
        PREV_TAG_REF="v${{ needs.generate-tag.outputs.previous_tag }}"
        echo "Checking for changes since ${PREV_TAG_REF}..."
        
        # Check if the previous tag exists
        if ! git rev-parse "${PREV_TAG_REF}" >/dev/null 2>&1; then
          echo "Previous tag ${PREV_TAG_REF} not found, will build images"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "source_tag=" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Check for changes in the ubuntu-devtools directory
        CHANGES=$(git diff --name-only "${PREV_TAG_REF}" HEAD -- base-env/images/ubuntu-devtools/ || true)
        
        if [[ -z "$CHANGES" ]]; then
          echo "No changes detected in base-env/images/ubuntu-devtools/ since ${PREV_TAG_REF}"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "source_tag=25.04-${{ needs.generate-tag.outputs.previous_tag }}" >> $GITHUB_OUTPUT
        else
          echo "Changes detected in base-env/images/ubuntu-devtools/:"
          echo "$CHANGES"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "source_tag=" >> $GITHUB_OUTPUT
        fi

  build-or-retag-base:
    needs: [generate-tag, check-ubuntu-changes]
    permissions:
      contents: read
      packages: write
    if: needs.check-ubuntu-changes.outputs.has_changes == 'true'
    uses: ./.github/workflows/docker-publish.yml
    with:
      context_dir: base-env/images/ubuntu-devtools
      dockerfile: base-env/images/ubuntu-devtools/Dockerfile
      tag: ${{ needs.generate-tag.outputs.ubuntu_tag }}
      image_name: superfly/sprite-ubuntu
      version: ${{ needs.generate-tag.outputs.is_version_tag == 'true' && github.ref_name || '' }}
      git_sha: ${{ needs.generate-tag.outputs.is_version_tag == 'false' && needs.generate-tag.outputs.short_sha || '' }}
      cache_tag: 25.04-latest
      latest_tag: 25.04-latest
      tag_latest: ${{ needs.generate-tag.outputs.is_version_tag == 'false' && (inputs.tag_latest == true || inputs.tag_latest == null) }}
    secrets: inherit

  retag-base:
    needs: [generate-tag, check-ubuntu-changes]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    if: needs.check-ubuntu-changes.outputs.has_changes == 'false'
    steps:
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Retag existing image
      run: |
        SOURCE_TAG="${{ needs.check-ubuntu-changes.outputs.source_tag }}"
        TARGET_TAG="${{ needs.generate-tag.outputs.ubuntu_tag }}"
        
        echo "Retagging ${SOURCE_TAG} as ${TARGET_TAG}..."
        
        # Create manifest for multi-arch retagging
        docker buildx imagetools create \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TARGET_TAG} \
          ${{ needs.generate-tag.outputs.is_version_tag == 'false' && (inputs.tag_latest == true || inputs.tag_latest == null) && format('-t {0}/{1}:25.04-latest', env.REGISTRY, env.IMAGE_NAME) || '' }} \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SOURCE_TAG}

  build-or-retag-languages:
    needs: [generate-tag, check-ubuntu-changes, build-or-retag-base, retag-base]
    if: always() && (needs.build-or-retag-base.result == 'success' || needs.retag-base.result == 'success') && needs.check-ubuntu-changes.outputs.has_changes == 'true'
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/docker-publish.yml
    with:
      context_dir: base-env/images/ubuntu-devtools
      dockerfile: base-env/images/ubuntu-devtools/Dockerfile
      tag: ${{ needs.generate-tag.outputs.ubuntu_tag }}-languages
      image_name: superfly/sprite-ubuntu
      target: languages
      cache_tag: 25.04-languages-latest
      latest_tag: 25.04-languages-latest
      tag_latest: ${{ needs.generate-tag.outputs.is_version_tag == 'false' && (inputs.tag_latest == true || inputs.tag_latest == null) }}
      version: ${{ needs.generate-tag.outputs.is_version_tag == 'true' && github.ref_name || '' }}
      git_sha: ${{ needs.generate-tag.outputs.is_version_tag == 'false' && needs.generate-tag.outputs.short_sha || '' }}
    secrets: inherit

  retag-languages:
    needs: [generate-tag, check-ubuntu-changes, build-or-retag-base, retag-base]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    if: always() && (needs.build-or-retag-base.result == 'success' || needs.retag-base.result == 'success') && needs.check-ubuntu-changes.outputs.has_changes == 'false'
    steps:
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Retag existing languages image
      run: |
        SOURCE_TAG="${{ needs.check-ubuntu-changes.outputs.source_tag }}-languages"
        TARGET_TAG="${{ needs.generate-tag.outputs.ubuntu_tag }}-languages"
        
        echo "Retagging ${SOURCE_TAG} as ${TARGET_TAG}..."
        
        # Create manifest for multi-arch retagging
        docker buildx imagetools create \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TARGET_TAG} \
          ${{ needs.generate-tag.outputs.is_version_tag == 'false' && (inputs.tag_latest == true || inputs.tag_latest == null) && format('-t {0}/{1}:25.04-languages-latest', env.REGISTRY, env.IMAGE_NAME) || '' }} \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SOURCE_TAG}

  build-sprite-env:
    needs: generate-tag
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/docker-publish.yml
    with:
      context_dir: .
      dockerfile: ./Dockerfile
      tag: ${{ needs.generate-tag.outputs.sprite_env_tag }}
      image_name: superfly/sprite-env
      cache_tag: latest
      latest_tag: latest
      tag_latest: ${{ needs.generate-tag.outputs.is_version_tag == 'false' && (inputs.tag_latest == true || inputs.tag_latest == null) }}
      version: ${{ needs.generate-tag.outputs.is_version_tag == 'true' && github.ref_name || '' }}
      git_sha: ${{ needs.generate-tag.outputs.is_version_tag == 'false' && needs.generate-tag.outputs.short_sha || '' }}
    secrets: inherit