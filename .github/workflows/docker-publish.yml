name: Reusable Docker Publish

on:
  workflow_call:
    inputs:
      context_dir:
        description: 'Docker build context directory'
        required: true
        type: string
      dockerfile:
        description: 'Path to Dockerfile'
        required: true
        type: string
      tag:
        description: 'Tag for the final image'
        required: true
        type: string
      image_name:
        description: 'Image name (without registry)'
        required: true
        type: string
      target:
        description: 'Docker build target (optional)'
        required: false
        type: string
      tag_latest:
        description: 'Also tag as latest'
        required: false
        type: boolean
        default: true
      latest_tag:
        description: 'Specific latest tag to use (e.g., "latest", "25.04-latest")'
        required: false
        type: string
      cache_tag:
        description: 'Tag to use for cache-from (e.g., "latest", "25.04-latest")'
        required: true
        type: string
      version:
        description: 'Version string to embed (passed as build-arg VERSION)'
        required: false
        type: string
      git_sha:
        description: 'Short git sha to embed for dev builds (build-arg GIT_SHA)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io

jobs:
  build-amd64:
    runs-on:
      - codebuild-sprite-env-${{ github.run_id }}-${{ github.run_attempt }}
        image:latest
        instance-size:large
    outputs:
      digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GH_PAT || github.token }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push AMD64 image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: ${{ inputs.context_dir }}
        file: ${{ inputs.dockerfile }}
        target: ${{ inputs.target }}
        platforms: linux/amd64
        push: true
        tags: ${{ env.REGISTRY }}/${{ inputs.image_name }}:${{ inputs.tag }}-amd64
        build-args: |
          ${{ inputs.version != '' && format('VERSION={0}', inputs.version) || '' }}
          ${{ inputs.git_sha != '' && format('GIT_SHA={0}', inputs.git_sha) || '' }}
        cache-from: | 
          type=registry,ref=${{ env.REGISTRY }}/${{ inputs.image_name }}:${{ inputs.cache_tag }}
          type=gha,scope=amd64
        cache-to: type=gha,mode=max,scope=amd64

  build-arm64:
    runs-on:
      - codebuild-sprite-env-${{ github.run_id }}-${{ github.run_attempt }}
        image:arm-latest
        instance-size:large
    outputs:
      digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GH_PAT || github.token }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push ARM64 image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: ${{ inputs.context_dir }}
        file: ${{ inputs.dockerfile }}
        target: ${{ inputs.target }}
        platforms: linux/arm64
        push: true
        tags: ${{ env.REGISTRY }}/${{ inputs.image_name }}:${{ inputs.tag }}-arm64
        build-args: |
          ${{ inputs.version != '' && format('VERSION={0}', inputs.version) || '' }}
          ${{ inputs.git_sha != '' && format('GIT_SHA={0}', inputs.git_sha) || '' }}
        cache-from: | 
          type=registry,ref=${{ env.REGISTRY }}/${{ inputs.image_name }}:${{ inputs.cache_tag }}
          type=gha,scope=arm64
        cache-to: type=gha,mode=max,scope=arm64

  manifest:
    runs-on:
      - codebuild-sprite-env-${{ github.run_id }}-${{ github.run_attempt }}
        image:latest
        instance-size:large
    needs: [build-amd64, build-arm64]

    steps:
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Create and push multi-platform manifest
      run: |
        docker buildx imagetools create \
          -t ${{ env.REGISTRY }}/${{ inputs.image_name }}:${{ inputs.tag }} \
          ${{ inputs.tag_latest && inputs.latest_tag && format('-t {0}/{1}:{2}', env.REGISTRY, inputs.image_name, inputs.latest_tag) || '' }} \
          ${{ env.REGISTRY }}/${{ inputs.image_name }}@${{ needs.build-amd64.outputs.digest }} \
          ${{ env.REGISTRY }}/${{ inputs.image_name }}@${{ needs.build-arm64.outputs.digest }}