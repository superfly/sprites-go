name: Tests

on:
  push:
    branches:
      - main
      - 'test/**'
    paths:
      - '.github/workflows/test.yml'
      - 'go.*'
      - 'Dockerfile'
      - 'tests/**'
      - 'server/**'
      - 'lib/**'
      - 'pkg/**'
      - 'client/**'
      - 'scripts/**'
  pull_request:
    paths:
      - '.github/workflows/test.yml'
      - 'go.*'
      - 'Dockerfile'
      - 'tests/**'
      - 'server/**'
      - 'lib/**'
      - 'pkg/**'
      - 'client/**'
      - 'scripts/**'
  workflow_call:  # This allows other workflows to call this one

jobs:
  test-lib:
    name: "Tests"
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.pull_request.title, '[skip ci]') && !contains(github.event.pull_request.title, '[ci skip]') }}
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GH_PAT || github.token }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Go modules and build cache
      uses: actions/cache@v4
      with:
        path: |
          .cache/go-pkg
          .cache/go-build
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-${{ hashFiles('**/*.go') }}
        restore-keys: |
          ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-
          ${{ runner.os }}-go-mod-${{ hashFiles('**/go.sum') }}
          ${{ runner.os }}-go-
          ${{ runner.os }}-go-mod-

    - name: Build test Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile.test
        push: false
        load: true
        tags: sprite-env-tests:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Create cache directories
      run: |
        mkdir -p .cache/go-pkg .cache/go-build

    - name: Run tests in Docker
      id: run_tests
      run: |
        docker run --rm --privileged \
          -e SPRITE_TEST_DOCKER=1 \
          -e CI=true \
          -e GOMODCACHE=/go/pkg/mod \
          -e GOCACHE=/root/.cache/go-build \
          -v "$(pwd)":/workspace \
          -v "$(pwd)/.cache/go-pkg:/go/pkg" \
          -v "$(pwd)/.cache/go-build:/root/.cache/go-build" \
          -w /workspace \
          sprite-env-tests \
          ./scripts/run-tests.sh

    - name: Generate test summary
      if: always() && steps.run_tests.outcome != 'skipped' && hashFiles('test-results/test-summary.md') != ''
      run: |
        cat test-results/test-summary.md >> $GITHUB_STEP_SUMMARY

  short-sha:
    name: Compute short SHA
    runs-on: ubuntu-latest
    outputs:
      short: ${{ steps.s.outputs.short }}
    steps:
    - name: Compute
      id: s
      run: echo "short=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT

  

