name: Tests

on:
  push:
    branches:
      - main
      - 'test/**'
    paths:
      - '.github/workflows/test.yml'
      - 'go.*'
      - 'Dockerfile'
      - 'tests/**'
      - 'server/**'
      - 'lib/**'
      - 'pkg/**'
      - 'client/**'
      - 'scripts/**'
  pull_request:
    paths:
      - '.github/workflows/test.yml'
      - 'go.*'
      - 'Dockerfile'
      - 'tests/**'
      - 'server/**'
      - 'lib/**'
      - 'pkg/**'
      - 'client/**'
      - 'scripts/**'
  workflow_call:  # This allows other workflows to call this one

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: superfly/sprite-env

jobs:
  test-lib:
    name: "Tests"
    runs-on: ubuntu-latest
    # runs-on:
    #   group: sprite-env-amd64
    if: ${{ !contains(github.event.pull_request.title, '[skip ci]') && !contains(github.event.pull_request.title, '[ci skip]') }}
    permissions:
      contents: read
      checks: write
      pull-requests: write
      packages: write

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GH_PAT || github.token }}

    - name: Prepare Docker tag
      id: docker_tag
      run: |
        # Hash the ref name to create a valid Docker tag
        TAG_HASH=$(echo -n "${{ github.ref_name }}" | sha256sum | cut -c1-12)
        echo "tag=$TAG_HASH" >> $GITHUB_OUTPUT

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache-dependency-path: go.sum

    - name: Cache workspace Go build cache
      uses: actions/cache@v4
      with:
        path: tmp/go-build
        key: ${{ runner.os }}-go-build-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-build-

    - name: Cache workspace Go module cache
      uses: actions/cache@v4
      with:
        path: tmp/go-mod
        key: ${{ runner.os }}-go-mod-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-mod-

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push test Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile.test
        push: true
        load: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-${{ steps.docker_tag.outputs.tag }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-latest
        # Cache configuration: use registry cache first, fallback to GHA cache
        cache-from: |
          type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-latest
          type=gha,scope=test
        cache-to: type=gha,mode=max,scope=test

    - name: Run tests in Docker
      id: run_tests
      run: |
        # Ensure workspace-local Go cache directories exist
        mkdir -p tmp/go-build tmp/go-mod
        
        docker run --rm --privileged \
          -e SPRITE_TEST_DOCKER=1 \
          -e CI=true \
          -e GOCACHE=/workspace/tmp/go-build \
          -e GOMODCACHE=/workspace/tmp/go-mod \
          -v "$(pwd)":/workspace \
          -w /workspace \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-${{ steps.docker_tag.outputs.tag }} \
          ./scripts/run-tests.sh

    - name: Generate test summary
      if: always() && steps.run_tests.outcome != 'skipped' && hashFiles('test-results/test-summary.md') != ''
      run: |
        cat test-results/test-summary.md >> $GITHUB_STEP_SUMMARY

  trigger-release:
    name: Trigger Release
    needs: [test-lib]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev-release')
    permissions:
      actions: write
    steps:
    - name: Trigger Release Workflow
      run: |
        gh workflow run release.yml --ref ${{ github.ref_name }}
      env:
        GH_TOKEN: ${{ github.token }}
        GH_REPO: ${{ github.repository }}

