name: Tests

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/test.yml'
      - 'go.*'
      - 'Dockerfile'
      - 'tests/**'
      - 'server/**'
      - 'lib/**'
      - 'packages/**'
      - 'client/**'
  pull_request:
    paths:
      - '.github/workflows/test.yml'
      - 'go.*'
      - 'Dockerfile'
      - 'tests/**'
      - 'server/**'
      - 'lib/**'
      - 'packages/**'
      - 'client/**'
  workflow_call:  # This allows other workflows to call this one

jobs:
  test-lib:
    name: "Tests"
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GH_PAT || github.token }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build test Docker image with cache
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.test
        push: false
        load: true
        tags: sprite-env-tests:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64

    - name: Run tests in Docker
      run: |
        docker run --rm --privileged \
          -e SPRITE_TEST_DOCKER=1 \
          -v "$(pwd)":/workspace \
          -w /workspace \
          sprite-env-tests \
          ./scripts/run-tests.sh
  
  # validate-traces:
  #   name: Validate Traces
  #   runs-on: ubuntu-latest
  #   needs: [test-models, test-server-integration]
  #   if: success()

  #   steps:
  #   - name: Checkout repo
  #     uses: actions/checkout@v4

  #   - name: Set up Java
  #     uses: actions/setup-java@v4
  #     with:
  #       distribution: 'temurin'
  #       java-version: '11'

  #   - name: Set up Python
  #     uses: actions/setup-python@v4
  #     with:
  #       python-version: '3.x'

  #   - name: Download trace artifacts
  #     uses: actions/download-artifact@v4
  #     with:
  #       name: trace-files
  #       path: server/tests/tmp/

  #   - name: Validate traces
  #     run: make validate-traces
  
