name: Tests

on:
  push:
    branches:
      - main
      - 'test/**'
    paths:
      - '.github/workflows/test.yml'
      - 'go.*'
      - 'Dockerfile'
      - 'tests/**'
      - 'server/**'
      - 'lib/**'
      - 'pkg/**'
      - 'client/**'
      - 'scripts/**'
  pull_request:
    paths:
      - '.github/workflows/test.yml'
      - 'go.*'
      - 'Dockerfile'
      - 'tests/**'
      - 'server/**'
      - 'lib/**'
      - 'pkg/**'
      - 'client/**'
      - 'scripts/**'
  workflow_call:  # This allows other workflows to call this one

jobs:
  test-lib:
    name: "Tests"
    runs-on:
      - codebuild-sprite-env-${{ github.run_id }}-${{ github.run_attempt }}
        image:latest
        instance-size:large
    if: ${{ !contains(github.event.pull_request.title, '[skip ci]') && !contains(github.event.pull_request.title, '[ci skip]') }}
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GH_PAT || github.token }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build test Docker image (non-main)
      if: ${{ github.ref != 'refs/heads/main' }}
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile.test
        push: false
        load: true
        tags: sprite-env-tests:latest
        cache-from: type=gha,scope=main

    - name: Build test Docker image (main, cache save)
      if: ${{ github.ref == 'refs/heads/main' }}
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile.test
        push: false
        load: true
        tags: sprite-env-tests:latest
        cache-from: type=gha,scope=main
        cache-to: type=gha,mode=max,scope=main

    - name: Run tests in Docker
      id: run_tests
      run: |
        docker run --rm --privileged \
          -e SPRITE_TEST_DOCKER=1 \
          -e CI=true \
          -v "$(pwd)":/workspace \
          -w /workspace \
          sprite-env-tests \
          ./scripts/run-tests.sh

    - name: Generate test summary
      if: always() && steps.run_tests.outcome != 'skipped' && hashFiles('test-results/test-summary.md') != ''
      run: |
        cat test-results/test-summary.md >> $GITHUB_STEP_SUMMARY

  short-sha:
    name: Compute short SHA
    runs-on:
      - codebuild-sprite-env-${{ github.run_id }}-${{ github.run_attempt }}
        image:latest
        instance-size:large
    outputs:
      short: ${{ steps.s.outputs.short }}
    steps:
    - name: Compute
      id: s
      run: echo "short=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT

  

